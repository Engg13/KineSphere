<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>KineSphere - Dashboard</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- ✅ PULL-TO-REFRESH -->
  <ion-refresher slot="fixed" (ionRefresh)="recargarDashboard($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Tira para recargar"
      refreshingSpinner="circles"
      refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <div class="ion-padding">
    <!-- HEADER PERSONALIZADO -->
    <div class="custom-header">
      <div class="main-title">
        <h1>Bienvenido, {{ usuarioNombre }}</h1>
      </div>
      <div class="subtitle">
        <p>Resumen de tu actividad clínica</p>
        <!-- ✅ NUEVO: Mostrar fuente de datos -->
        @if (plataformaUsada) {
          <small class="data-source">
            Datos cargados desde: {{ plataformaUsada }}
          </small>
        }
      </div>
    </div>

    <!-- ✅ LOADING STATE -->
    @if (estaCargando) {
      <div class="loading-container ion-text-center ion-padding">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Actualizando datos...</p>
      </div>
    }

    <!-- TARJETAS DE ESTADÍSTICAS -->
    @if (!estaCargando) {
      <ion-grid class="animated-item">
        <ion-row>
          <ion-col size="4">
            <ion-card (click)="irAPacientes()" class="stat-card card-primary">
              <ion-card-content class="ion-text-center">
                <ion-icon name="people" size="large"></ion-icon>
                <h2>{{ totalPacientes }}</h2>
                <p>Pacientes</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="4">
            <ion-card (click)="irASesion()" class="stat-card card-secondary">
              <ion-card-content class="ion-text-center">
                <ion-icon name="calendar" size="large"></ion-icon>
                <h2>{{ sesionesHoy }}</h2>
                <p>Sesiones Hoy</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="4">
            <ion-card class="stat-card card-tertiary">
              <ion-card-content class="ion-text-center">
                <ion-icon name="document-text" size="large"></ion-icon>
                <h2>{{ evaluacionesPendientes }}</h2>
                <p class="texto-mas-pequeno">Evaluaciones</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    }

    <!-- PACIENTES RECIENTES -->
    @if (!estaCargando) {
      <ion-card class="animated-item">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="time" slot="start"></ion-icon>
            Pacientes Recientes
          </ion-card-title>
          @if (pacientesRecientes.length > 0) {
            <ion-card-subtitle>
              Últimos {{ pacientesRecientes.length }} pacientes agregados
            </ion-card-subtitle>
          }
        </ion-card-header>
        <ion-card-content>
          @if (pacientesRecientes.length > 0) {
            <div>
              <!-- LISTA DE PACIENTES RECIENTES -->
              <ion-list>
                @for (paciente of pacientesRecientes; track paciente; let i = $index) {
                  <ion-item
                    (click)="verDetallePaciente(paciente)"
                    button
                    detail
                    class="paciente-item animated-item"
                    [style.animation-delay]="(i * 0.1) + 's'">
                    <ion-avatar slot="start">
                      <ion-icon name="person-circle" size="large"></ion-icon>
                    </ion-avatar>
                    <ion-label>
                      <h2>{{ paciente.nombre }}</h2>
                      <p>{{ paciente.diagnostico }}</p>
                      <p>
                        <ion-badge [color]="paciente.activo ? 'success' : 'medium'">
                          {{ paciente.activo ? 'Activo' : 'Finalizado' }}
                        </ion-badge>
                        • Sesiones: {{ paciente.sesionesCompletadas || 0 }}/{{ paciente.sesionesPlanificadas || 0 }}
                        • RUT: {{ paciente.rut }}
                      </p>
                      <small>
                        Creado: {{ paciente.fechaCreacion | date:'dd/MM/yyyy' }}
                      </small>
                    </ion-label>
                    @if (paciente.ultimaSesion) {
                      <ion-note slot="end">
                        Última sesión:<br>
                        {{ paciente.ultimaSesion | date:'dd/MM' }}
                      </ion-note>
                    }
                  </ion-item>
                }
              </ion-list>
            </div>
          }
          @if (pacientesRecientes.length === 0 && !estaCargando) {
            <div class="ion-text-center empty-state">
              <ion-icon name="people-outline" size="large" color="medium"></ion-icon>
              <h3>No hay pacientes registrados</h3>
              <p>Comienza agregando tu primer paciente</p>
              <ion-button (click)="agregarPaciente()" color="primary" fill="outline" class="ion-margin-top">
                <ion-icon slot="start" name="add"></ion-icon>
                Agregar Primer Paciente
              </ion-button>
            </div>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- ACCIONES RÁPIDAS -->
    @if (!estaCargando) {
      <ion-card class="animated-item">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="flash" slot="start"></ion-icon>
            Acciones Rápidas
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-button expand="block" (click)="irAPacientes()" [disabled]="totalPacientes === 0">
                  <ion-icon name="people-outline" slot="start"></ion-icon>
                  Ver Pacientes
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button expand="block" (click)="irASesion()" [disabled]="totalPacientes === 0">
                  <ion-icon name="calendar-outline" slot="start"></ion-icon>
                  Nueva Sesión
                </ion-button>
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col size="6">
                <ion-button expand="block" (click)="irAEvaluaciones()" color="tertiary" fill="outline" [disabled]="totalPacientes === 0">
                  <ion-icon name="document-text-outline" slot="start"></ion-icon>
                  Evaluación Final
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button expand="block" (click)="irAEjercicios()" color="success" fill="outline">
                  <ion-icon name="barbell-outline" slot="start"></ion-icon>
                  Ejercicios
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
          <!-- ✅ INFORMACIÓN DEL ESTADO DE CARGA (MOVIDO AQUÍ) -->
          @if (plataformaUsada) {
            <div class="ion-margin-top ion-text-center">
              <ion-chip color="medium">
                <ion-label>Modo: {{ plataformaUsada }}</ion-label>
              </ion-chip>
            </div>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- BOTÓN AGREGAR PACIENTE FLOATING -->
    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button color="primary" (click)="agregarPaciente()">
        <ion-icon name="add"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  </div>
</ion-content>