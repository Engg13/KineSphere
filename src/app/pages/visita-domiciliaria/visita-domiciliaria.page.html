<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="volverAlPaciente()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Visita Domiciliaria</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="ion-padding">
    
    <!-- INFORMACIN DEL PACIENTE -->
    <ion-card *ngIf="paciente" class="paciente-info">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="home" slot="start"></ion-icon>
          Visita a Domicilio
        </ion-card-title>
        <ion-card-subtitle>
          Paciente: {{ paciente.nombre }}
        </ion-card-subtitle>
      </ion-card-header>
    </ion-card>

    <!-- ESTADO DE CARGA -->
    <div *ngIf="estaCargando" class="loading-container ion-text-center ion-padding">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Obteniendo ubicaci贸n...</p>
    </div>

    <!-- MAPA -->
    <div *ngIf="ubicacionActual && !estaCargando" class="map-container">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="map" slot="start"></ion-icon>
            Ubicaci贸n Actual
          </ion-card-title>
          <ion-card-subtitle>
             Lat: {{ ubicacionActual.latitud?.toFixed(6) }}, 
            Lng: {{ ubicacionActual.longitud?.toFixed(6) }}
          </ion-card-subtitle>
        </ion-card-header>
        
        <ion-card-content>
          <!-- CONTENEDOR DEL MAPA -->
          <div #map class="map"></div>
          
          <!-- INFORMACIN DE UBICACIN -->
          <ion-grid class="ubicacion-info">
            <ion-row>
              <ion-col size="6">
                <p><strong>Precisi贸n:</strong> {{ ubicacionActual.precision?.toFixed(1) }}m</p>
              </ion-col>
              <ion-col size="6">
                <p><strong>Hora:</strong> {{ ubicacionActual.timestamp | date:'HH:mm' }}</p>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- BOTONES DE ACCIN -->
    <ion-grid class="botones-accion" *ngIf="!estaCargando">
      <ion-row>
        <ion-col size="6">
          <ion-button 
            expand="block"  
            (click)="obtenerUbicacionActual()"
            [disabled]="estaCargando">
            <ion-icon slot="start" name="refresh"></ion-icon>
            Actualizar Ubicaci贸n
          </ion-button>
        </ion-col>
        <ion-col size="6">
          <ion-button 
            expand="block"  
            (click)="iniciarSeguimientoUbicacion()"
            [disabled]="!ubicacionActual">
            <ion-icon slot="start" name="navigate"></ion-icon>
            Seguir Ubicaci贸n
          </ion-button>
        </ion-col>
      </ion-row>
      
      <ion-row>
        <ion-col size="12">
          <ion-button 
            expand="block"  
            (click)="guardarVisitaDomiciliaria()"
            [disabled]="!ubicacionActual">
            <ion-icon slot="start" name="save"></ion-icon>
            Guardar Visita
          </ion-button>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col size="12">
          <ion-button 
            expand="block" 
            fill="outline" 
            (click)="volverAlPaciente()">
            <ion-icon slot="start" name="arrow-back"></ion-icon>
            Volver al Paciente
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- ESTADO SIN UBICACIN -->
    <div *ngIf="!ubicacionActual && !estaCargando" class="empty-state ion-text-center ion-padding">
      <ion-icon name="location-outline" size="large" color="medium"></ion-icon>
      <h3>Ubicaci贸n no disponible</h3>
      <p>Usa el bot贸n "Actualizar Ubicaci贸n" para obtener tu ubicaci贸n actual</p>
    </div>

  </div>
</ion-content>